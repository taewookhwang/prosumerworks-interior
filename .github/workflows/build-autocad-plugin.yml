name: Build AutoCAD Plugin

on:
  workflow_dispatch:
  push:
    paths:
      - 'apps/api/design-automation/plugin/**'
      - '.github/workflows/build-autocad-plugin.yml'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup .NET Framework
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet packages
        working-directory: apps/api/design-automation/plugin
        run: dotnet restore ExtractCoords.csproj

      - name: Build Plugin
        shell: pwsh
        working-directory: apps/api/design-automation/plugin
        run: |
          Write-Host "=== Current directory ==="
          Write-Host $PWD

          Write-Host "=== Building plugin with dotnet build ==="
          dotnet build ExtractCoords.csproj -c Release

          Write-Host "=== Build output ==="
          Get-ChildItem -Recurse "bin" -Filter "*.dll" | ForEach-Object {
            Write-Host "  $($_.FullName) - $($_.Length) bytes"
          }

      - name: Create Bundle
        shell: pwsh
        working-directory: apps/api/design-automation/plugin
        run: |
          Write-Host "=== Finding build output ==="
          Get-ChildItem -Recurse "bin" -Filter "*.dll" | ForEach-Object {
            Write-Host "Found: $($_.FullName)"
          }

          # Find the actual output directory
          $outputDir = $null
          $possiblePaths = @(
            "bin/Release",
            "bin/Release/net48",
            "bin/Any CPU/Release",
            "bin/x64/Release"
          )

          foreach ($path in $possiblePaths) {
            if (Test-Path "$path/ExtractCoords.dll") {
              $outputDir = $path
              Write-Host "Found output at: $outputDir"
              break
            }
          }

          if ($outputDir -eq $null) {
            Write-Error "Could not find ExtractCoords.dll in any expected location!"
            exit 1
          }

          # Create bundle structure
          New-Item -ItemType Directory -Path "bundle/ExtractCoords.bundle/Contents" -Force

          # Copy main DLL
          Copy-Item "$outputDir/ExtractCoords.dll" -Destination "bundle/ExtractCoords.bundle/Contents/"
          Write-Host "Copied: ExtractCoords.dll"

          # Copy PackageContents.xml
          Copy-Item "PackageContents.xml" -Destination "bundle/ExtractCoords.bundle/"
          Write-Host "Copied: PackageContents.xml"

          # Copy dependency DLLs (excluding AutoCAD/ObjectARX assemblies)
          Get-ChildItem "$outputDir/*.dll" | ForEach-Object {
            # Skip AutoCAD assemblies - they are provided by Design Automation runtime
            if ($_.Name -match "^(Ac|acdb|AcMgd)") {
              Write-Host "Skipping AutoCAD assembly: $($_.Name)"
            } elseif ($_.Name -eq "ExtractCoords.dll") {
              # Already copied
            } else {
              Copy-Item $_.FullName -Destination "bundle/ExtractCoords.bundle/Contents/"
              Write-Host "Copied dependency: $($_.Name)"
            }
          }

          Write-Host "=== Bundle contents ==="
          Get-ChildItem -Recurse "bundle"

          # Create zip file
          Compress-Archive -Path "bundle/ExtractCoords.bundle/*" -DestinationPath "ExtractCoords.bundle.zip" -Force
          Write-Host "Created: ExtractCoords.bundle.zip"

      - name: Verify Bundle
        shell: pwsh
        working-directory: apps/api/design-automation/plugin
        run: |
          Write-Host "=== Verifying bundle zip ==="
          Expand-Archive -Path "ExtractCoords.bundle.zip" -DestinationPath "verify" -Force
          Get-ChildItem -Recurse "verify" | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }

          # Check DLL size (should be > 20KB for a proper build)
          $dll = Get-Item "verify/Contents/ExtractCoords.dll"
          Write-Host "ExtractCoords.dll size: $($dll.Length) bytes"
          if ($dll.Length -lt 20000) {
            Write-Warning "DLL size is smaller than expected. Build might be incomplete."
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ExtractCoords-Plugin
          path: apps/api/design-automation/plugin/ExtractCoords.bundle.zip
          retention-days: 90
