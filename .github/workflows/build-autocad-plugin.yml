name: Build AutoCAD Plugin

on:
  workflow_dispatch:
  push:
    paths:
      - 'apps/api/design-automation/plugin/**'
      - '.github/workflows/build-autocad-plugin.yml'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup .NET Framework
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Create ObjectARX Stub Assemblies
        shell: pwsh
        working-directory: apps/api/design-automation/plugin
        run: |
          Write-Host "=== Creating stub assemblies using csc.exe ==="

          # Create lib directory
          $libPath = Join-Path $PWD "lib"
          New-Item -ItemType Directory -Path $libPath -Force | Out-Null
          Write-Host "Created lib directory: $libPath"

          # Find csc.exe
          $cscPath = "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe"
          if (-not (Test-Path $cscPath)) {
            $cscPath = "C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe"
          }

          if (-not (Test-Path $cscPath)) {
            Write-Error "Could not find csc.exe!"
            exit 1
          }
          Write-Host "Using csc.exe: $cscPath"

          # Verify source file exists
          $stubSource = Join-Path $PWD "scripts\ObjectARXStubs.cs"
          if (-not (Test-Path $stubSource)) {
            Write-Error "Stub source not found: $stubSource"
            exit 1
          }
          Write-Host "Stub source: $stubSource"

          # Compile AcCoreMgd.dll
          $acCorePath = Join-Path $libPath "AcCoreMgd.dll"
          Write-Host "Compiling AcCoreMgd.dll..."
          & $cscPath /target:library /out:$acCorePath /nologo /nowarn:CS0169,CS0649 $stubSource

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to compile AcCoreMgd.dll (exit code: $LASTEXITCODE)"
            exit 1
          }

          if (-not (Test-Path $acCorePath)) {
            Write-Error "AcCoreMgd.dll was not created!"
            exit 1
          }
          Write-Host "Created: $acCorePath"

          # Copy as AcDbMgd.dll
          $acDbPath = Join-Path $libPath "AcDbMgd.dll"
          Copy-Item $acCorePath -Destination $acDbPath
          Write-Host "Created: $acDbPath"

          # Verify both files exist
          Write-Host "=== Verifying lib contents ==="
          Get-ChildItem $libPath | ForEach-Object {
            Write-Host "  $($_.Name) - $($_.Length) bytes"
          }

          if ((Test-Path $acCorePath) -and (Test-Path $acDbPath)) {
            Write-Host "=== Stub assemblies created successfully! ==="
          } else {
            Write-Error "Stub assembly verification failed!"
            exit 1
          }

      - name: Restore NuGet packages
        working-directory: apps/api/design-automation/plugin
        run: nuget restore ExtractCoords.csproj -NoCache

      - name: Build Plugin
        shell: pwsh
        working-directory: apps/api/design-automation/plugin
        run: |
          Write-Host "=== Current directory ==="
          Write-Host $PWD

          Write-Host "=== Verifying lib folder ==="
          $libPath = Join-Path $PWD "lib"
          if (Test-Path $libPath) {
            Get-ChildItem $libPath | ForEach-Object {
              Write-Host "  $($_.Name) - $($_.Length) bytes"
            }
          } else {
            Write-Error "lib folder not found!"
            exit 1
          }

          Write-Host "=== Verifying .csproj references ==="
          $csprojPath = Join-Path $PWD "ExtractCoords.csproj"
          Select-String -Path $csprojPath -Pattern "HintPath"

          Write-Host "=== Building plugin with verbose output ==="
          msbuild ExtractCoords.csproj /p:Configuration=Release /p:Platform="Any CPU" /v:normal

          Write-Host "=== Build output ==="
          if (Test-Path "bin/Release") {
            Get-ChildItem "bin/Release" | ForEach-Object {
              Write-Host "  $($_.Name) - $($_.Length) bytes"
            }
          }

      - name: Create Bundle
        shell: pwsh
        working-directory: apps/api/design-automation/plugin
        run: |
          Write-Host "=== Finding build output ==="
          Get-ChildItem -Recurse "bin" -Filter "*.dll" | ForEach-Object {
            Write-Host "Found: $($_.FullName)"
          }

          # Find the actual output directory
          $outputDir = $null
          $possiblePaths = @(
            "bin/Release",
            "bin/Any CPU/Release",
            "bin/Release/net48",
            "bin/x64/Release"
          )

          foreach ($path in $possiblePaths) {
            if (Test-Path "$path/ExtractCoords.dll") {
              $outputDir = $path
              Write-Host "Found output at: $outputDir"
              break
            }
          }

          if ($outputDir -eq $null) {
            Write-Error "Could not find ExtractCoords.dll in any expected location!"
            exit 1
          }

          New-Item -ItemType Directory -Path "bundle/ExtractCoords.bundle/Contents" -Force

          Copy-Item "$outputDir/ExtractCoords.dll" -Destination "bundle/ExtractCoords.bundle/Contents/"
          Copy-Item "PackageContents.xml" -Destination "bundle/ExtractCoords.bundle/"

          Get-ChildItem "$outputDir/*.dll" | ForEach-Object {
            if ($_.Name -notmatch "^Ac") {
              Copy-Item $_.FullName -Destination "bundle/ExtractCoords.bundle/Contents/"
              Write-Host "Copied: $($_.Name)"
            }
          }

          Write-Host "=== Bundle contents ==="
          Get-ChildItem -Recurse "bundle"

          Compress-Archive -Path "bundle/ExtractCoords.bundle/*" -DestinationPath "ExtractCoords.bundle.zip" -Force

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ExtractCoords-Plugin
          path: apps/api/design-automation/plugin/ExtractCoords.bundle.zip
          retention-days: 90
