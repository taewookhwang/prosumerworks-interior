name: Build AutoCAD Plugin

on:
  workflow_dispatch:
  push:
    paths:
      - 'apps/api/design-automation/plugin/**'
      - '.github/workflows/build-autocad-plugin.yml'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET Framework
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Create ObjectARX Stub Assemblies
        shell: pwsh
        run: |
          $libPath = "apps/api/design-automation/plugin/lib"
          New-Item -ItemType Directory -Path $libPath -Force

          Write-Host "Compiling ObjectARX stub assemblies..."

          $cscPath = "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe"
          $stubsPath = "apps/api/design-automation/plugin/scripts/ObjectARXStubs.cs"

          & $cscPath /target:library /out:"$libPath\AcCoreMgd.dll" /nologo $stubsPath
          Copy-Item "$libPath\AcCoreMgd.dll" -Destination "$libPath\AcDbMgd.dll"

          Write-Host "Library folder contents:"
          Get-ChildItem $libPath

      - name: Update csproj with absolute paths
        shell: pwsh
        run: |
          $csprojPath = "apps/api/design-automation/plugin/ExtractCoords.csproj"
          $libPath = "${{ github.workspace }}\apps\api\design-automation\plugin\lib"

          $content = Get-Content $csprojPath -Raw
          $content = $content -replace '\$\(AutoCADPath\)', $libPath
          $content | Set-Content $csprojPath -Encoding UTF8

          Write-Host "Updated csproj:"
          Get-Content $csprojPath

      - name: Restore NuGet packages
        run: nuget restore apps/api/design-automation/plugin/ExtractCoords.csproj -NoCache

      - name: Build Plugin
        shell: pwsh
        run: |
          cd apps/api/design-automation/plugin

          Write-Host "Library folder contents:"
          Get-ChildItem lib

          msbuild ExtractCoords.csproj /p:Configuration=Release /p:Platform="Any CPU"

      - name: Create Bundle
        shell: pwsh
        run: |
          cd apps/api/design-automation/plugin

          New-Item -ItemType Directory -Path "bundle/ExtractCoords.bundle/Contents" -Force

          Copy-Item "bin/Release/ExtractCoords.dll" -Destination "bundle/ExtractCoords.bundle/Contents/"
          Copy-Item "PackageContents.xml" -Destination "bundle/ExtractCoords.bundle/"

          Get-ChildItem "bin/Release/*.dll" | ForEach-Object {
            if ($_.Name -notmatch "^Ac") {
              Copy-Item $_.FullName -Destination "bundle/ExtractCoords.bundle/Contents/"
              Write-Host "Copied: $($_.Name)"
            }
          }

          Write-Host "Bundle contents:"
          Get-ChildItem -Recurse "bundle"

          Compress-Archive -Path "bundle/ExtractCoords.bundle/*" -DestinationPath "ExtractCoords.bundle.zip" -Force

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ExtractCoords-Plugin
          path: apps/api/design-automation/plugin/ExtractCoords.bundle.zip
          retention-days: 90
