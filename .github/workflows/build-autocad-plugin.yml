name: Build AutoCAD Plugin

on:
  workflow_dispatch:
  push:
    paths:
      - 'apps/api/design-automation/plugin/**'
      - '.github/workflows/build-autocad-plugin.yml'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup .NET Framework
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Create ObjectARX Stub Assemblies
        shell: pwsh
        working-directory: apps/api/design-automation/plugin
        run: |
          New-Item -ItemType Directory -Path "lib" -Force

          Write-Host "=== Creating stub project ==="

          # Create a temporary .NET project to compile the stubs
          $stubProjectDir = "temp_stubs"
          New-Item -ItemType Directory -Path $stubProjectDir -Force

          # Create project file
          $csproj = @"
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup>
              <TargetFramework>net48</TargetFramework>
              <OutputType>Library</OutputType>
              <AssemblyName>AcCoreMgd</AssemblyName>
            </PropertyGroup>
          </Project>
          "@
          $csproj | Out-File -FilePath "$stubProjectDir/stubs.csproj" -Encoding UTF8

          # Copy stub source
          Copy-Item "scripts/ObjectARXStubs.cs" -Destination "$stubProjectDir/"

          Write-Host "=== Building stub assembly ==="
          Push-Location $stubProjectDir

          # Try dotnet build first
          dotnet build -c Release -o ../lib 2>&1

          if ($LASTEXITCODE -ne 0) {
            Write-Host "dotnet build failed, trying csc.exe..."

            # Find csc.exe
            $cscPaths = @(
              "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe",
              "C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe"
            )

            foreach ($cscPath in $cscPaths) {
              if (Test-Path $cscPath) {
                Write-Host "Using: $cscPath"
                & $cscPath /target:library /out:"..\lib\AcCoreMgd.dll" /nologo ObjectARXStubs.cs
                break
              }
            }
          }

          Pop-Location

          # Create copy for AcDbMgd
          if (Test-Path "lib/AcCoreMgd.dll") {
            Copy-Item "lib/AcCoreMgd.dll" -Destination "lib/AcDbMgd.dll"
            Write-Host "=== Stub assemblies created ==="
          } else {
            Write-Error "Failed to create stub assemblies!"
            exit 1
          }

          Get-ChildItem lib

          # Cleanup
          Remove-Item -Recurse -Force $stubProjectDir -ErrorAction SilentlyContinue

      - name: Restore NuGet packages
        working-directory: apps/api/design-automation/plugin
        run: nuget restore ExtractCoords.csproj -NoCache

      - name: Build Plugin
        shell: pwsh
        working-directory: apps/api/design-automation/plugin
        run: |
          Write-Host "=== Verifying lib folder ==="
          Get-ChildItem lib

          Write-Host "=== Building plugin ==="
          msbuild ExtractCoords.csproj /p:Configuration=Release /p:Platform="Any CPU"

      - name: Create Bundle
        shell: pwsh
        working-directory: apps/api/design-automation/plugin
        run: |
          New-Item -ItemType Directory -Path "bundle/ExtractCoords.bundle/Contents" -Force

          Copy-Item "bin/Release/ExtractCoords.dll" -Destination "bundle/ExtractCoords.bundle/Contents/"
          Copy-Item "PackageContents.xml" -Destination "bundle/ExtractCoords.bundle/"

          Get-ChildItem "bin/Release/*.dll" | ForEach-Object {
            if ($_.Name -notmatch "^Ac") {
              Copy-Item $_.FullName -Destination "bundle/ExtractCoords.bundle/Contents/"
              Write-Host "Copied: $($_.Name)"
            }
          }

          Write-Host "=== Bundle contents ==="
          Get-ChildItem -Recurse "bundle"

          Compress-Archive -Path "bundle/ExtractCoords.bundle/*" -DestinationPath "ExtractCoords.bundle.zip" -Force

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ExtractCoords-Plugin
          path: apps/api/design-automation/plugin/ExtractCoords.bundle.zip
          retention-days: 90
